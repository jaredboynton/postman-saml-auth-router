# Postman Desktop Authentication Flow Analysis

## Captured Flow Sequence

### 1. Initial Authentication Request
- **URL**: `https://auth.postman.com/__redirect/client/login`
- **Parameters**:
  - `multiLoginToken`: Long token (128 chars)
  - `redirect_uri`: `postman://auth/callback`
  - `auth_challenge`: NOT present initially!
  - `auth_device`: `app_native`
  - `auth_device_version`: `11.58.4`

### 2. Redirect to identity.getpostman.com
- **From**: `auth.postman.com`
- **To**: `https://identity.getpostman.com/client/login`
- **Preserves**: All parameters from step 1

### 3. Client Login Page
- **URL**: `https://identity.getpostman.com/client/login`
- **Shows**: Login options including "Sign In with SSO"
- **SSO Link**: `/enterprise/login?auth_challenge=b84b016bb49f711fa2e1961561cb59845d3ba275901d0e3632ee645dde7e6463&auth_device=app_native&auth_device_version=11.58.4`
- **NOTE**: `auth_challenge` appears HERE for the first time!

### 4. Enterprise Login (Team Name Entry)
- **URL**: `/enterprise/login`
- **Action**: User enters team name "postman"
- **Response**: `{"redirect":"/enterprise/login/authchooser"}`

### 5. Auth Chooser Page
- **URL**: `/enterprise/login/authchooser`
- **Shows**: Okta login button
- **Okta Link**: `/sso/okta/db1b1a3764f24213906d682e26fd366f/init`

### 6. SAML Redirect to Okta
- **URL**: `/sso/okta/db1b1a3764f24213906d682e26fd366f/init`
- **Redirects to**: `https://postman.okta.com/app/getpostman/exk2e5ac26g30Z4QB5d7/sso/saml`
- **With**: SAMLRequest parameter

### 7. Okta Authentication
- User authenticates with Okta

### 8. SAML Callback
- **Returns to**: `https://identity.getpostman.com/browser-auth/success`
- **With**: OAuth authorization code
- **Code**: `42cbc48421f0d275d1381770f3f0d349fb7f12c1c0274030f1d4a87b789a7999`

## Key Discoveries

### 1. auth_challenge Generation
- **NOT** passed from Postman Desktop initially
- **Generated** by identity.getpostman.com when showing login page
- Appears first in the SSO link on `/client/login` page

### 2. multiLoginToken
- This is the PRIMARY authentication token from Desktop
- 128-character token passed throughout
- Must be preserved in all redirects

### 3. Two Different Flows
- **Web Client**: Uses `/client/browser-auth/init`
- **Desktop**: Uses `/client/login` directly

## Daemon Issues

### Current Implementation Problems:

1. **Missing multiLoginToken handling**
   - Daemon doesn't preserve multiLoginToken parameter
   - This is CRITICAL for Desktop auth

2. **Wrong auth_challenge assumption**
   - Daemon expects auth_challenge from Desktop
   - But it's generated by identity.getpostman.com

3. **Incorrect redirect logic**
   - Daemon redirects `/login` directly to SAML
   - Should let identity.getpostman.com generate auth_challenge first

4. **Missing /client/login handler**
   - This is the actual Desktop entry point
   - Different from web browser flow

## Correct Flow for Daemon

1. **Intercept** `/client/login` (not just `/login`)
2. **Preserve** multiLoginToken throughout
3. **Let** identity.getpostman.com generate auth_challenge
4. **Only intercept** `/enterprise/login/authchooser` to skip auth method selection
5. **Preserve** all OAuth parameters in SAML redirect

## Required Changes

```python
# 1. Handle /client/login differently
if self.path.startswith('/client/login'):
    # Let it pass through to generate auth_challenge
    self.proxy_request()
    return

# 2. Intercept authchooser with auth_challenge
if self.path.startswith('/enterprise/login/authchooser'):
    # Extract auth_challenge that was generated
    params = parse_qs(urlparse(self.path).query)
    
    # Redirect to SAML with auth_challenge
    saml_url = f"/sso/okta/db1b1a3764f24213906d682e26fd366f/init"
    
    # Preserve auth_challenge and other params
    saml_params = {
        'auth_challenge': params.get('auth_challenge', []),
        'auth_device': params.get('auth_device', []),
        'auth_device_version': params.get('auth_device_version', [])
    }
```