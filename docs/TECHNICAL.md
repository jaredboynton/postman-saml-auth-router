# Postman Authentication Flow - Technical Implementation

This document contains technical details for developers and security researchers.

## Authentication Flow Sequence (from Burp Suite capture)

1. **Initial Request**: `https://auth.postman.com/__redirect/client/login` (NOT intercepted)
2. **Redirect to**: `https://identity.getpostman.com/client/login` 
3. **User clicks SSO**: `/enterprise/login?auth_challenge=...` (auth_challenge generated HERE)
4. **Team entry**: User enters team name "postman"
5. **Auth chooser**: `/enterprise/login/authchooser` 
6. **SAML redirect**: `/sso/okta/db1b1a3764f24213906d682e26fd366f/init`
7. **Okta auth**: User authenticates
8. **Callback**: Returns with OAuth code

## Critical Parameter Discoveries

- **`multiLoginToken`**: 128-character token from Desktop - MUST be preserved throughout
- **`auth_challenge`**: NOT sent from Desktop! Generated by identity.getpostman.com on first visit
- Desktop uses `/client/login`, not `/login` (different from web flow)

## Certificate Requirements

### Domains Required in SAN:
- identity.getpostman.com
- identity.postman.com  
- identity.postman.co
- localhost
- IP: 127.0.0.1

### Trust Settings:
Certificate MUST be added with proper SSL trust:
```bash
sudo security add-trusted-cert -d -r trustRoot -k /Library/Keychains/System.keychain cert.pem
```

Without `-r trustRoot`, the certificate is in keychain but NOT trusted for SSL!

## Daemon Behavior

### State Machine Interception Points:
1. Let `/client/login` pass through (generates auth_challenge)
2. Intercept `/enterprise/login` to skip team entry
3. Intercept `/authchooser` to skip auth method selection
4. Preserve ALL parameters, especially multiLoginToken

### DNS Resolution
The daemon uses a DNSResolver class to get real IP addresses for Postman domains, avoiding proxy loops caused by /etc/hosts entries.

### SSL/SNI Handling
Uses socket-level SSL with proper Server Name Indication (SNI) for Cloudflare compatibility:
```python
ssl_socket = context.wrap_socket(raw_socket, server_hostname=host)
```

## Security Considerations

- Postman Desktop may use certificate pinning in future versions
- Some Electron apps bypass system hosts file using DoH or hardcoded IPs
- Always use self-signed certificates responsibly
- All proof-of-concept code includes security warnings
- This is legitimate security research within authorized scope

## Architecture

The daemon operates as an HTTPS proxy that:
1. Intercepts specific authentication endpoints
2. Redirects to SAML-only flow
3. Passes through OAuth continuation
4. Maintains full SSL/TLS encryption

Zero external dependencies - uses only Python standard library for maximum enterprise compatibility.

## Enterprise MDM Deployment

See `MDM_IMPLEMENTATION_PLAN.md` for complete enterprise deployment guidance including JAMF/SCCM/Intune configuration.

---
*For operational usage, see CLAUDE.md*