# Postman Authentication Flow Analysis

## Summary

After analyzing both the HAR file (Desktop auth with existing account) and Burp capture (SAML flow), the authentication requires minimal interception at specific points while preserving critical OAuth/PKCE parameters.

## Critical Discovery: Auth Challenge Generation

The `auth_challenge` is **NOT** sent from Desktop initially. It's generated by the server at `/client-auth/confirm` or during the `/client/login` redirect chain. This MUST NOT be intercepted.

## Desktop Authentication Flow (from HAR)

1. **Initial**: Desktop opens `/client/login` with `multiLoginToken` (128 chars)
2. **Server generates**: `auth_challenge` via `/client-auth/confirm` 
3. **Redirect**: `/login?auth_challenge=...` (user sees login page)
4. **User action**: Clicks "Sign in with SSO"
5. **Team entry**: `/enterprise/login` (user enters team)
6. **Auth chooser**: `/enterprise/login/authchooser` (user selects SAML)
7. **SAML**: `/sso/okta/{tenant}/init` → Okta → callback
8. **OAuth dance**: Multiple `/continue?state=...` redirects across domains
9. **Success**: `/browser-auth/success` with OAuth code

## Web Authentication Flow (from Burp)

Similar to Desktop but:
- No initial `multiLoginToken`
- No `auth_challenge` in initial request
- User directly accesses `/login`
- Same team entry and SAML flow afterward

## State Parameter Tracking

The OAuth state parameter changes across domains for security:
```
identity.postman.co/continue?state=AAA...
→ identity.postman.com/continue?state=BBB...
→ id.gw.postman.com/continue?state=CCC...
```

Each domain validates and generates a new state. Breaking this chain causes 401 errors.

## State Machine Flow

The daemon tracks authentication using a 6-state machine:

```
IDLE → AUTH_INIT → LOGIN_REDIRECT → SAML_FLOW → OAUTH_CONTINUATION → COMPLETE
```

**State Transitions:**
1. **IDLE**: No authentication in progress
2. **AUTH_INIT**: User starts authentication (Desktop or Browser)
3. **LOGIN_REDIRECT**: Daemon intercepts login page, redirects to SAML
4. **SAML_FLOW**: SAML authentication in progress with IdP
5. **OAUTH_CONTINUATION**: OAuth state machine (NEVER intercept)
6. **COMPLETE**: Authentication successful, reset to IDLE after 5 seconds

**Critical Rule:** Once in OAUTH_CONTINUATION state, the daemon never intercepts any requests. This ensures the OAuth state machine completes successfully across all Postman domains.

## Minimal Interception Strategy

### MUST Pass Through (Never Intercept)
1. `/client/login` - Generates auth_challenge
2. `/client-auth/*` - Auth challenge generation
3. `/client/browser-auth/*` - Browser auth init
4. `/continue?state=...` - OAuth state machine (CRITICAL)
5. `/sso/okta/*/callback` - SAML responses
6. Any request with Okta/SAML referrer (prevent loops)

### OAuth Continuation Timeout Protection

The daemon implements a **30-second timeout** for OAuth continuation states:

```python
if self.current_state == AuthState.OAUTH_CONTINUATION:
    if (datetime.now() - self.state_entered_at).seconds > 30:
        # Reset to IDLE to prevent stuck sessions
        self.current_state = AuthState.IDLE
    return False  # NEVER intercept during OAuth flow
```

**Why 30 seconds:**
- Typical OAuth flows complete in 5-10 seconds
- Allows for slow networks and processing delays
- Prevents sessions stuck indefinitely in OAuth state
- Automatic recovery from network interruptions

**What happens during timeout:**
- State machine resets to IDLE
- Next authentication attempt starts fresh
- No impact on user experience (transparent recovery)

### SHOULD Intercept (Force SAML)
1. `/login?auth_challenge=...` (Desktop flow)
   - Redirect to: `/sso/okta/{tenant}/init?team=postman&auth_challenge=...`
   
2. `/enterprise/login` (Team entry page)
   - Redirect to: `/enterprise/login/authchooser?team=postman&...`
   
3. `/enterprise/login/authchooser` (Auth method selection)
   - Redirect to: `/sso/okta/{tenant}/init?team=postman&...`

### Key Parameters to Preserve
- `auth_challenge` - PKCE challenge for Desktop
- `auth_device` - Device type (app_native)
- `auth_device_version` - Desktop version
- `multiLoginToken` - Desktop session token
- `state` - OAuth state (changes per domain)
- `team` - Enterprise team name

## Implementation Notes

1. **State Tracking**: Track OAuth state parameters to recognize valid continuation requests
2. **Referrer Checking**: Check Referer header to prevent redirect loops from SAML callbacks
3. **Parameter Preservation**: Always preserve all OAuth/PKCE parameters when redirecting
4. **Team Injection**: Add `team` parameter to skip manual entry
5. **Minimal Touch**: Only intercept where absolutely necessary

## Testing Checklist

- [ ] Desktop: Opens Postman, clicks Sign In
- [ ] Desktop: Automatically redirects to SAML (no team entry)
- [ ] Desktop: Completes Okta auth
- [ ] Desktop: Successfully logs in (no 401 error)
- [ ] Web: Direct browser access to identity.getpostman.com/login
- [ ] Web: Redirects to SAML with team
- [ ] Web: Completes authentication
- [ ] No redirect loops (ERR_TOO_MANY_REDIRECTS)
- [ ] OAuth state preserved across domain hops
- [ ] No manual team entry required

## Common Issues

### 401 "The request is unauthenticated"
- OAuth state chain broken
- Missing auth_challenge in Desktop flow
- Intercepting `/continue` endpoints incorrectly

### ERR_TOO_MANY_REDIRECTS
- Not checking Referer to prevent loops
- Intercepting SAML callback redirects
- Not tracking state parameters

### Team entry page still shows
- Not intercepting `/enterprise/login`
- Not adding `team` parameter to redirects
- Wrong team parameter format (should be query param, not POST)